/*
 * File: app/view/SearchCondition.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('TeamDomain.view.SearchCondition', {
    extend: 'Ext.form.Panel',
    alias: 'widget.searchcondition',
    frame: true,
    id: 'searchCondition',
    autoScroll: true,
    layout: {
        align: 'stretch',
        padding: 5,
        type: 'vbox'
    },
    title: '検索',
    initComponent: function () {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'fieldset',
                    margin: 0,
                    padding: '0 10 0 10',
                    title: 'このフォルダの配下でファイルを検索',
                    items: [
                        {
                            xtype: 'hiddenfield',
                            anchor: '100%',
                            fieldLabel: 'Label',
                            name: 'cont_location'
                        },
                        {
                            xtype: 'hiddenfield',
                            anchor: '100%',
                            fieldLabel: 'Label',
                            name: 'hash_key'
                        },
                        {
                            xtype: 'displayfield',
                            anchor: '100%',
                            height: 20,
                            name: 'text'
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    margin: '5 0 0 0',
                    padding: '0 10 2 10',
                    title: '検索条件',
                    items: [
                        {
                            xtype: 'textfield',
                            anchor: '100%',
                            fieldLabel: 'ファイル名',
                            labelWidth: 70,
                            name: 'target_file_name'
                        },
                        {
                            xtype: 'fieldcontainer',
                            height: 46,
                            hidden: true,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: 'サイズ',
                            labelWidth: 70,
                            items: [
                                {
                                    xtype: 'numberfield',
                                    flex: 1,
                                    fieldLabel: '最少(バイト)',
                                    labelAlign: 'top',
                                    labelPad: 2,
                                    name: 'target_file_size_min',
                                    hideTrigger: true,
                                    allowDecimals: false
                                },
                                {
                                    xtype: 'label',
                                    padding: '23 0 0 5',
                                    width: 20,
                                    text: '～'
                                },
                                {
                                    xtype: 'numberfield',
                                    flex: 1,
                                    fieldLabel: '最大(バイト)',
                                    labelAlign: 'top',
                                    labelPad: 2,
                                    name: 'target_file_size_max',
                                    hideTrigger: true
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    height: 47,
                    margin: '5 0 0 0',
                    padding: '0 10 0 10',
                    title: '検索文字列の条件',
                    items: [
                        {
                            xtype: 'fieldcontainer',
                            height: 27,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '',
                            items: [
                                {
                                    xtype: 'checkboxfield',
                                    flex: 1,
                                    margins: '0 0 0 10',
                                    fieldLabel: '',
                                    name: 'target_check_str_size',
                                    boxLabel: '大文字・小文字区別',
                                    uncheckedValue: 'off'
                                },
                                {
                                    xtype: 'checkboxfield',
                                    flex: 1,
                                    margins: '0 0 0 10',
                                    fieldLabel: '',
                                    name: 'target_check_str_char',
                                    boxLabel: '全角・半角区別',
                                    uncheckedValue: 'off'
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    height: 80,
                    margin: '5 0 0 0',
                    padding: '0 10 0 10',
                    title: '作成情報の条件',
                    items: [
                        {
                            xtype: 'fieldcontainer',
                            height: 27,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '',
                            items: [
                                {
                                    xtype: 'textfield',
                                    flex: 1.5,
                                    fieldLabel: '作成者名',
                                    labelWidth: 70,
                                    name: 'target_creator'
                                },
                                {
                                    xtype: 'checkboxfield',
                                    flex: 1,
                                    margins: '0 0 0 15',
                                    fieldLabel: '',
                                    name: 'target_created_by_me',
                                    boxLabel: '自己作成',
                                    uncheckedValue: 'off'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldcontainer',
                            height: 24,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '作成日付',
                            labelWidth: 70,
                            items: [
                                {
                                    xtype: 'datefield',
                                    flex: 1,
                                    width: 150,
                                    fieldLabel: '',
                                    name: 'target_created_date_begin'
                                },
                                {
                                    xtype: 'label',
                                    padding: '3 0 0 5',
                                    width: 20,
                                    text: '～'
                                },
                                {
                                    xtype: 'datefield',
                                    flex: 1,
                                    fieldLabel: '',
                                    name: 'target_created_date_end'
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    height: 80,
                    margin: '5 0 0 0',
                    padding: '0 10 0 10',
                    title: '更新情報の条件',
                    items: [
                        {
                            xtype: 'fieldcontainer',
                            height: 27,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '',
                            items: [
                                {
                                    xtype: 'textfield',
                                    flex: 1.5,
                                    fieldLabel: '更新者名',
                                    labelWidth: 70,
                                    name: 'target_modifier'
                                },
                                {
                                    xtype: 'checkboxfield',
                                    flex: 1,
                                    margins: '0 0 0 15',
                                    fieldLabel: '',
                                    name: 'target_modified_by_me',
                                    boxLabel: '自己更新',
                                    uncheckedValue: 'off'
                                }
                            ]
                        },
                        {
                            xtype: 'fieldcontainer',
                            height: 24,
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '更新日付',
                            labelWidth: 70,
                            items: [
                                {
                                    xtype: 'datefield',
                                    flex: 1,
                                    width: 150,
                                    fieldLabel: '',
                                    name: 'target_modified_date_begin'
                                },
                                {
                                    xtype: 'label',
                                    padding: '3 0 0 5',
                                    width: 20,
                                    text: '～'
                                },
                                {
                                    xtype: 'datefield',
                                    flex: 1,
                                    fieldLabel: '',
                                    name: 'target_modified_date_end'
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldset',
                    flex: 1,
                    height: 175,
                    margin: '5 0 0 0',
                    padding: '0 10 2 10',
                    layout: {
                        align: 'stretch',
                        padding: 0,
                        type: 'vbox'
                    },
                    title: '検索オプション',
                    items: [
                        {
                            xtype: 'gridpanel',
                            flex: 1,
                            id: 'searchOption',
                            autoScroll: true,
                            store: 'SearchOptionStore',
                            viewConfig: {
                                deferEmptyText: false
                            },
                            selModel: Ext.create('Ext.selection.CheckboxModel', {
                            }),
                            columns: [
                                {
                                    xtype: 'gridcolumn',
                                    width: 100,
                                    dataIndex: 'option_name',
                                    text: 'オプション属性'
                                },
                                {
                                    xtype: 'gridcolumn',
                                    id: 'option_value',
                                    width: 209,
                                    dataIndex: 'value',
                                    text: '内容',
                                    flex: 1,
                                    editor: {
                                        xtype: 'textfield'
                                    }
                                }
                            ],
                            plugins: [
                                Ext.create('Ext.grid.plugin.CellEditing', {
                                })
                            ]
                        },
                        {
                            xtype: 'fieldcontainer',
                            height: 60,
                            margin: '0 0 5 0',
                            layout: {
                                align: 'stretch',
                                type: 'hbox'
                            },
                            fieldLabel: '',
                            items: [
                                {
                                    xtype: 'fieldcontainer',
                                    flex: 1,
                                    height: 120,
                                    margin: '2 0 5 0',
                                    layout: {
                                        align: 'stretch',
                                        type: 'vbox'
                                    },
                                    fieldLabel: '',
                                    items: [
                                        {
                                            xtype: 'checkboxfield',
                                            flex: 1,
                                            fieldLabel: '',
                                            name: 'target_subfolder',
                                            value: false,
                                            boxLabel: 'サブフォルダも検索',
                                            inputValue: 'true',
                                            uncheckedValue: 'false'
                                        }
                                    ]
                                },
                                {
                                    xtype: 'fieldcontainer',
                                    flex: 1,
                                    height: 120,
                                    margin: '2 0 5 5',
                                    layout: {
                                        align: 'stretch',
                                        type: 'vbox'
                                    },
                                    fieldLabel: '',
                                    items: [
                                        {
                                            xtype: 'checkboxfield',
                                            flex: 1,
                                            hidden: true,
                                            fieldLabel: '',
                                            name: 'locked_by_me',
                                            value: false,
                                            boxLabel: '自己ロック',
                                            inputValue: 'true',
                                            uncheckedValue: 'false'
                                        },
                                        {
                                            xtype: 'checkboxfield',
                                            flex: 1,
                                            hidden: true,
                                            fieldLabel: '',
                                            name: 'checked_out_by_me',
                                            value: false,
                                            boxLabel: '自己チェックアウト',
                                            inputValue: 'true',
                                            uncheckedValue: 'false'
                                        }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'fieldcontainer',
                    width: 400,
                    items: [
                        {
                            xtype: 'button',
                            handler: function (button, event) {
                                var grid = Ext.getCmp('searchOption');

                                var records = grid.getSelectionModel().getSelection(), data = [];
                                for (var i = 0; i < records.length; i++) {
                                    data.push(records[i].data);
                                }

                                var formX = this.up('form').getForm().getFieldValues();

                                if (formX.text == '') {
                                    Ext.Msg.show({
                                        title: 'フォルダ選択',
                                        msg: '検索対象のフォルダを選択してください',
                                        buttons: Ext.Msg.OK
                                    });
                                    return;
                                }

                                var dataX = Ext.apply({'property': data});
                                var dataY = Ext.apply(formX, dataX);

                                dataY = Ext.apply({session_id: this_session_id}, dataY);
                                dataZ = Ext.apply({request_type: "search_files"}, dataY);

                                Ext.Ajax.request({
                                    url: 'tdx/updatedata.tdx',
                                    method: 'POST',
                                    jsonData: dataZ,
                                    success: handleSuccess,
                                    timeout: 7200000,
                                    failure: handleFailure
                                });

                                Ext.Msg.show({
                                    title: 'ファイル検索中',
                                    msg: 'ファイル検索中です'
                                });


                                function handleSuccess(response) {
                                    obj = Ext.decode(response.responseText);
                                    var request_success = obj.success;
                                    var request_status = obj.status;

                                    if (request_success === false) {
                                        var request_errors = obj.errors;
                                        Ext.Msg.hide();
                                        Ext.Msg.show({
                                            title: 'ファイル検索失敗',
                                            msg: request_errors,
                                            buttons: Ext.Msg.OK
                                        });
                                        Ext.getCmp('searchDsp').show();
                                        Ext.getStore('FileDataStoreS').removeAll();
                                    } else {
                                        if (request_status == 1035) {
                                            Ext.getCmp('searchDsp').show();
                                            Ext.getStore('FileDataStoreS').removeAll();
                                            Ext.Msg.hide();
                                            Ext.Msg.show({
                                                title: 'ファイル検索失敗',
                                                msg: '該当するファイルが見つかりませんでした',
                                                buttons: Ext.Msg.OK
                                            });
                                        } else {
                                            Ext.Msg.hide();
                                            Ext.getCmp('searchDsp').show();
                                            Ext.getCmp('searchDsp').expand();
                                            Ext.getCmp('filesS_list').moveFirst();
                                        }
                                    }
                                    return;
                                }

                                function handleFailure(response) {
                                    Ext.Msg.hide();
                                    Ext.Msg.show({
                                        title: 'ファイル検索失敗',
                                        msg: 'サーバとの通信に失敗しました',
                                        buttons: Ext.Msg.OK
                                    });
                                    Ext.getCmp('searchDsp').show();
                                    Ext.getStore('FileDataStoreS').removeAll();
                                }

                            },
                            margin: '5 0 0 120',
                            width: 100,
                            text: '検索開始',
                            tooltip: {
                                html: '指定したフォルダ配下のファイルを検索します。<br/>	それぞれの項目に検索条件を入力して下さい。<br/>検索オプションは、チェックボックスをチェックした項目のみが対象となります。<br/>	オプション属性の内容をダブルクリックすると変更することができます。'
                            },
                            tooltipType: 'title'
                        },
                        {
                            xtype: 'button',
                            handler: function (button, event) {
                                Ext.getCmp('eastSidePanel').hide();
                            },
                            margin: '5 0 0 5',
                            width: 100,
                            text: '閉じる',
                            tooltip: '詳細検索を閉じます。',
                            tooltipType: 'title'
                        }
                    ]
                }
            ],
            listeners: {
                afterrender: {
                    fn: me.onSearchConditionAfterRender,
                    scope: me
                }
            }
        });

        me.callParent(arguments);
    },
    onSearchConditionAfterRender: function (component, eOpts) {
        //Ext.getStore('SearchConditionStore').load();
        Ext.getStore('SearchOptionStore').load();
    }

});
